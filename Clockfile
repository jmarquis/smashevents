$stdout.sync = true
using RubyClock::DSL

around_action do |job_proc, job_info|
  Rails.logger.info "Starting job: #{job_info[:task]}" unless job_info[:task] == 'setbot:run'
  job_proc.call
  Rails.logger.info "Job finished: #{job_info[:task]}" unless job_info[:task] == 'setbot:run'
  STDOUT.flush
end

on_error do |job, error|
  case job
  when String # this means there was a problem parsing the Clockfile while starting
    Sentry.capture_exception(StandardError.new('Error when loading Clockfile'))
  else
    Sentry.capture_exception(error)
  end
end


### DAILY JOBS

# 8:00am UTC
cron '0 8 * * *', locals: { task: 'cleanup:delete_old_tournaments' } do
  rake_async('cleanup:delete_old_tournaments')
end

# 2:00pm UTC
cron '0 14 * * *', locals: { task: 'notifications:happening_today' } do
  rake_async('notifications:happening_today')
end

# 3:00pm UTC
cron '0 15 * * *', locals: { task: 'notifications:congratulations' } do
  rake_async('notifications:congratulations')
end

# 4:00pm UTC
cron '0 16 * * *', locals: { task: 'notifications:weekend_briefing' } do
  rake_async('notifications:weekend_briefing')
end

### HOURLY JOBS

# Every hour at :10
cron '10 * * * *', locals: { task: 'youtube:fetch_stream_urls' } do
  rake_async('youtube:fetch_stream_urls')
end

# Every hour at :40
cron '40 * * * *', locals: { task: 'startgg:sync' } do
  rake_async('startgg:sync')
end

### MORE FREQUENT JOBS

# Every 10 minutes
cron '*/10 * * * *', locals: { task: 'notifications:new_events' } do
  rake_async('notifications:new_events')
end

# Every 10 minutes (5 minute offset)
cron '5/10 * * * *', locals: { task: 'twitch:sync_streams' } do
  rake_async('twitch:sync_streams')
end

# Every 10 seconds
every '10 seconds', locals: { task: 'startgg:scan_stream_sets' }, overlap: false do
  rake_async('startgg:scan_stream_sets')
end

# Every minute
cron '* * * * *', locals: { task: 'setbot:run' }, overlap: false do
  rake_async('setbot:run')
end
