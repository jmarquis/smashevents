$stdout.sync = true
using RubyClock::DSL

# Noisy logs we don't really need
MUTED_JOB_LOGS = [
  'startgg:scan_sets'
]

around_action do |job_proc, job_info|
  Rails.logger.formatter.set_entrypoint(job_info[:task])
  Rails.logger.info "Starting task" unless job_info[:task].in? MUTED_JOB_LOGS
  StatsD.measure("cron.total_time.#{job_info[:task].gsub(':', '_')}") do
    job_proc.call
  end
  Rails.logger.info "Task finished" unless job_info[:task].in? MUTED_JOB_LOGS
  STDOUT.flush
end

on_error do |job, error|
  case job
  when String # this means there was a problem parsing the Clockfile while starting
    Sentry.capture_exception(StandardError.new('Error when loading Clockfile'))
  else
    Sentry.capture_exception(error)
  end
end


### DAILY JOBS

# 8:00am UTC
cron '0 8 * * *', locals: { task: 'cleanup:delete_old_tournaments' }, overlap: false do
  rake_async('cleanup:delete_old_tournaments')
end

# 2:00pm UTC
cron '0 14 * * *', locals: { task: 'notifications:happening_today' }, overlap: false do
  rake_async('notifications:happening_today')
end

# 3:00pm UTC
cron '0 15 * * *', locals: { task: 'notifications:congratulations' }, overlap: false do
  rake_async('notifications:congratulations')
end

# 4:00pm UTC
cron '0 16 * * *', locals: { task: 'notifications:weekend_briefing' }, overlap: false do
  rake_async('notifications:weekend_briefing')
end

### HOURLY JOBS

# Every hour at :10
cron '10 * * * *', locals: { task: 'youtube:fetch_stream_urls' }, overlap: false do
  rake_async('youtube:fetch_stream_urls')
end

### MORE FREQUENT JOBS

# Every 10 minutes (5 minute offset)
cron '5/10 * * * *', locals: { task: 'startgg:sync' }, overlap: false do
  rake_async('startgg:sync')
end

# Every 10 minutes
cron '*/10 * * * *', locals: { task: 'notifications:new_events' }, overlap: false do
  rake_async('notifications:new_events')
end

# Every minute
cron '* * * * *', locals: { task: 'twitch:sync_streams' }, overlap: false do
  rake_async('twitch:sync_streams')
end

# Every 10 seconds
every '10 seconds', locals: { task: 'startgg:scan_sets' }, overlap: false do
  rake_async('startgg:scan_sets')
end

# Every 10 seconds
# This is an "eternal" process so the interval is short just to make sure it
# starts up quickly after a deploy.
every '10 seconds', locals: { task: 'setbot:run' }, overlap: false do
  rake_async('setbot:run')
end
